import{s as P,z as R,c as z,l as g,a as c,b as B,d as v,t as E,e as y,m as C,j as k,f as N,i as D,R as M,g as H,h as x}from"./vendor.20c3140b.js";const G=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}};G();class f{constructor(t,s,r,i){this.left=i,this.right=s,this.top=t,this.bottom=r}static all(t){return new f(t,t,t,t)}}class ${constructor(t,s){this.#t=0,this.#e=0,this.elem=t,this.margin=s,this.refresh()}#t;#e;refresh(){const t=this.elem.getBoundingClientRect();this.#t=t.width,this.#e=t.height}get width(){return this.#t-this.margin.left-this.margin.right}get height(){return this.#e-this.margin.top-this.margin.bottom}}class J{constructor(t,s,r,i,a,o,n,l){this.ip_str=t,this.isp=s,this.org=r,this.os=i,this.port=a,this.timestamp=o,this.location=n,this.vulns=l}}class T{constructor(t,s,r,i,a){this.cve=t,this.count=s,this.verified=r,this.cvss=i,this.summary=a}}class X{constructor(t,s,r){this.val=t,this.name=s,this.vulns=r}total(t){return P(this.vulns.slice(t-1))}dimensions(t){const s=new Array(t-1).concat(this.vulns.slice(t-1));return R([0].concat(Array.from(z(s))),s)}}class K{constructor(t,s,r,i,a,o,n){this.township=s,this.province=r,this.longitude=i,this.latitude=a,this.city=t,this.population=o,this.total_devices=n}}class L{constructor(t,s){this.container=t,this.margin=s,this.dimensions=new $(t,s)}get width(){return this.dimensions.width}get height(){return this.dimensions.height}}let m=null,F=null,b={};class U extends L{constructor(t,s,r){super(document.querySelector("svg#left-plot"),new f(0,20,50,140));F=t.locations,this.data=t,this.choice=r,this.onSelect=s,this.scaleElem=document.querySelector("#scale"),this.objects=[],this.groups=[],this.minCVSS=1,this.x=g(),window.addEventListener("resize",()=>{this.dimensions.refresh(),this.updateChoice(this.choice,!1)}),this.svg=c(this.container).on("click",function(){m=null,c(this).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),s(null)}).append("g").attr("transform","translate(160, 0)"),this.svg.append("rect").attr("x","0").attr("y","0").attr("width",this.dimensions.width.toString()).attr("height",this.dimensions.height.toString()).attr("opacity","0"),this.xAxis=this.svg.append("g"),this.yAxis=this.svg.append("g"),this.bars=this.svg.append("g").attr("transform","translate(1, 0)"),this.updateChoice(r);let i=!1,a=0,o=!1;this.scaleElem.addEventListener("mousedown",n=>{const l=n;i=!1,o=!0,a=l.pageX}),this.scaleElem.addEventListener("mousemove",n=>{o&&(i||Math.abs(n.pageX-a)>10)&&(i=!0,this.update(!1))}),this.scaleElem.addEventListener("mouseup",()=>{i||this.update(!0),o=!1}),document.querySelector("#min-cvss")?.addEventListener("change",n=>{this.updateChoice(this.choice)})}updateChoice(t,s=!0){this.choice=t,this.objects=Object.values(Y(this.data.shodan,this.data.vulnerabilities,this.choice)),this.minCVSS=parseInt(document.querySelector("#min-cvss").value),this.objects.sort((o,n)=>n.total(this.minCVSS)-o.total(this.minCVSS)),this.objects=this.objects.slice(0,20),console.log(this.objects[0]),this.groups=this.objects.map(o=>o.name),this.x=this.x.domain([0,this.objects[0].total(this.minCVSS)]).range([0,this.width]),this.scaleElem.max=this.objects[0].total(this.minCVSS).toString(),this.scaleElem.min=this.objects[this.objects.length-1].total(this.minCVSS).toString(),this.scaleElem.value=this.scaleElem.max,this.xAxis.attr("transform",`translate(0, ${this.height})`);const r=B().domain(this.groups).range([10,this.height]).padding(.1);this.yAxis.call(v(r).tickSizeOuter(0).tickFormat(o=>this.choice=="os"?W(o,25):Q(o,25))).selectAll("text").style("text-anchor","end");const i=o=>E((o+1)/10),a=this.onSelect;this.bars.selectAll("g").data(this.objects).join("g").attr("id",o=>o.val).attr("transform",o=>`translate(0, ${r(o.name)})`).selectAll("rect").data(o=>o.dimensions(this.minCVSS)).join("rect").attr("class",(o,n)=>n.toString()+" bar").attr("height",r.bandwidth()).attr("fill",(o,n)=>i(n)).attr("opacity","1").on("click",function(o){o.stopPropagation();const n=this.parentElement;m==n?(c(n.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),m=null,a(null)):(m=n,c(n.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","0.4"),c(n).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),a(c(m).attr("id")))}),this.update(s)}update(t=!1){this.dimensions.refresh(),this.x=this.x.domain([0,parseInt(this.scaleElem.value)]),this.xAxis.call(y(this.x)).selectAll("text").attr("transform","translate(-10,0)rotate(-45)").style("text-anchor","end"),this.bars.selectAll("g").data(this.objects).selectAll("rect").data(s=>s.dimensions(this.minCVSS)).transition().duration(t?300:0).attr("x",s=>this.x(s[0])).attr("width",s=>this.x(s[1])),this.svg.selectAll(".bar").selectAll("*").remove()}clear(){this.svg.selectAll("*").remove()}}function Q(e,t){return e.length>t?e.slice(0,t-2)+"...":e}function W(e,t){if(e.length>t){const s=e.split(" "),r=s[s.length-1];return e.slice(0,t-r.length-2)+"..."+r}else return e}function Y(e,t,s){if(s in b)return b[s];const r={};for(const i of e){if(i[s]=="")continue;const a=Z(i,s);if(a!=null){a in r||(r[a]=new X(i[s].toString(),a.toString(),[0,0,0,0,0,0,0,0,0,0]));for(const o of i.vulns)r[a].vulns[Math.floor(t[o].cvss-1)]+=1}}return b[s]=r,r}function Z(e,t){switch(t){case"location":try{return F[e.location].city}catch{return null}default:return e[t]}}class tt extends L{constructor(t,s,r){super(t,new f(70,50,70,90));this.filter=null,this.filteredVulns=null,window.addEventListener("resize",()=>{this.update()}),this.shodan=s,this.vulnerabilities=r,this.cachedFilters={},this.selectedCVE=null,this.color=i=>E((i.cvss+1)/10),this.group=c(this.container).append("g").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`),this.x=g().domain([1,10]).range([0,this.width]),this.maxCount=C(r,i=>i.count),this.y=g().domain([0,this.maxCount]).range([this.height,0]),this.xAxis=this.group.append("g").attr("transform","translate(0,"+this.height+")").call(y(this.x)),this.group.append("text").attr("id","xLabel").attr("class","label").attr("text-anchor","end").attr("x",this.width).attr("y",this.height+50).text("Severity (CVSS score)"),this.yAxis=this.group.append("g").call(v(this.y)),this.group.append("text").attr("id","yLabel").attr("class","label").attr("text-anchor","end").attr("transform","rotate(-90)").attr("y",-this.margin.bottom).attr("x",0).text("Number of affected devices"),this.group.selectAll("dot").data(r).enter().append("circle").attr("r",4).attr("cvss",i=>i.cvss.toString()).on("mouseout",i=>{c(i.target).attr("opacity")!="0"&&this.tooltip.style("display","none")}).on("mouseover",(i,a)=>{if(c(i.target).attr("opacity")=="0")return;this.tooltip.style("display",null),this.tooltip.attr("transform",`translate(${this.x(a.cvss)},${+c(i.target).attr("cy")})`);const o=this.tooltip.selectAll("path").data([,]).join("path").attr("fill","white").attr("stroke","#ccc"),n=this.tooltip.selectAll("text").data([,]).join("text").call(p=>p.selectAll("tspan").data(`${a.cve}`.split(/\n/)).join("tspan").attr("x",0).attr("y",(j,I)=>`${I*1.1}em`).text(j=>j).style("font-size","0.8em")),{x:l,y:h,width:u,height:d}=n.node().getBBox();n.attr("transform",`translate(${-u/2},${h-7})`),o.attr("d",`M ${-u/2-6},-${d+21}
           H ${u/2+6}
           v ${d+12}
           H 5
           l -5,5
           l -5,-5
           H ${-u/2-5}
           z`)}).on("click",(i,a)=>{c(i.target).attr("opacity")!="0"&&(c("#cve-name").html(a.cve),c("#cve-summary").html(a.summary),c("#cve-cvss").html("CVSS: "+a.cvss.toString()).style("color",a.cvss>=7?"white":"black").style("background",this.color(a)),c("#cve-verified").html(a.verified?"verified":"unverified").style("background",a.verified?"lightblue":"lightcoral"),this.selectedCVE?.style("stroke",null),this.selectedCVE=c(i.target),this.selectedCVE.style("stroke","black"),this.update())}),this.update(),this.tooltip=this.group.append("g").style("pointer-events","none")}update(){this.dimensions.refresh(),this.x=this.x.range([1,this.width]),this.y=this.y.range([this.height,0]),this.yAxis.call(v(this.y)),this.xAxis.attr("transform","translate(0,"+this.height+")").call(y(this.x)),this.group.selectAll("circle").data(this.vulnerabilities).attr("opacity",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"0":"1").attr("pointer-events",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"none":null).attr("cy",(t,s)=>this.y(this.filteredVulns&&s in this.filteredVulns?this.filteredVulns[s]:t.count)).attr("cx",t=>this.x(t.cvss)).style("fill",this.color),this.group.select("#xLabel").attr("x",this.width).attr("y",this.height+50),this.group.select("#ylabel").attr("y",-this.margin.bottom)}setFilter(t,s){if(s){if(this.filter=s,t in this.cachedFilters&&s in this.cachedFilters[t])this.filteredVulns=this.cachedFilters[t][s];else{const r=this.shodan.filter(i=>i[t]==s).map(i=>i.vulns).flat();this.filteredVulns={};for(const i of r)i in this.filteredVulns?this.filteredVulns[i]+=1:this.filteredVulns[i]=1;t in this.cachedFilters||(this.cachedFilters[t]={}),this.cachedFilters[t][s]=this.filteredVulns}this.y=this.y.domain([0,C(Object.values(this.filteredVulns))])}else this.filter=null,this.filteredVulns=null,this.y=this.y.domain([0,this.maxCount]);this.yAxis.call(v(this.y)),this.update()}clear(){this.group.remove()}}const et={province:await k("data/nl_provinces.geojson"),township:await k("data/nl_townships.geojson")};function S(e,t,s){const r=document.querySelector("#resolution").value,i=document.querySelector("#scaling").value;document.querySelector("#resolution").onchange=function(){S(e,t,s)},document.querySelector("#scaling").onchange=function(){S(e,t,s)};const a=et[r],o=it(t,s,e,r),n=c("svg#map").attr("viewBox","0 0 500 500");n.selectAll("*").remove(),new $(document.querySelector("svg#map"),f.all(50));const l=500,h=500,u=N().center([5.3,52.2]).scale(6e3).translate([l/2,h/2]),d=st(r,i);return n.append("g").selectAll("path").data(a.features).enter().append("path").attr("id",p=>p.properties.name).attr("fill",p=>d(o,p.properties.name)).attr("d",D().projection(u)).style("stroke","black"),o}function st(e,t,s){let r;e==="province"?r={nil:5e4,capita:.1,fraction:.3}:r={nil:5e4,capita:5,fraction:30};let i=n=>M(n/r[t]);lt(i,r[t]);const o={nil:n=>n.total_vulns,capita:n=>n.total_vulns/n.population,fraction:n=>n.total_vulns/n.total_devices}[t];if(e==="province")return(n,l)=>i(o(n[l]));if(e==="township")return(n,l)=>l in n?i(o(n[l])):i(0);throw"Something is very wrong if it came to this"}function it(e,t,s,r){const i={},a=[];for(let l=0;l<e.length;l++){if(e[l].location>=s.length)continue;var o=rt(e[l].location,s,r),n=nt(e[l].vulns,t);o in i||(i[o]={severity_none:0,severity_low:0,severity_medium:0,severity_high:0,severity_critial:0,total_vulns:0,population:1,total_devices:1});const h=i[o];n<.1?h.severity_none+=1:n>=.1&&n<4?h.severity_low+=1:n>=4&&n<7?h.severity_medium+=1:n>=7&&n<9?h.severity_high+=1:n>=9&&n<=10&&(h.severity_critial+=1),h.total_vulns+=1,!a.includes(e[l].location)&&(h.total_devices+=ot(e[l].location,s),h.population+=at(e[l].location,s),a.push(e[l].location))}return i}function nt(e,t){return H(e,s=>t[s].cvss)}function rt(e,t,s){return t[e][s]}function at(e,t){return t[e].population}function ot(e,t){return t[e].total_devices}function lt(e,t){function s(n,l){const h=document.createElement("canvas");h.width=256,h.height=1;const u=h.getContext("2d");for(let d=0;d<256;++d)u.fillStyle=n(d/255*l),u.fillRect(d,0,1,1);return h}const r=400,i=30,a=c("svg#map-legend").attr("width",r).attr("height",i).attr("viewBox",`0 0 ${r} ${i}`).style("overflow","visible").style("display","block");a.selectAll("*").remove(),a.append("image").attr("x",0).attr("y",0).attr("width",r).attr("height",i).attr("preserveAspectRatio","none").attr("xlink:href",s(e,t).toDataURL());const o=g([0,t],[0,r]);a.append("g").attr("transform",`translate(0,${i})`).call(y(o).ticks(6))}function ct(e){return e.replace(/[\- ](Service Pack)?[\- ]?[0-9]+$/g,"")}const _=await x("data/shodan.csv",e=>new J(e.ip_str,e.isp,e.org,ct(e.os),parseInt(e.port),new Date(e.timestamp),parseInt(e.location),JSON.parse(e.vulns))),A=await x("data/vulnerabilities.csv",e=>new T(e.cve,parseInt(e.count),e.verified=="true",parseFloat(e.cvss),e.summary)),O=await x("data/locations.csv",e=>new K(e.city,e.township,e.province,parseFloat(e.longitude),parseFloat(e.latitude),parseInt(e.population),parseInt(e.total_devices))),ht={shodan:_,vulnerabilities:A,locations:O};let V=null;function q(e){V!=e&&(V=e,dt.setFilter(w.value,V))}const w=document.getElementById("category");w.onchange=function(){q(null),ut.updateChoice(w.value)};let ut=new U(ht,q,w.value),dt=new tt(document.querySelector("svg#right-plot"),_,A);const pt=S(O,_,A);var ft=(e,t)=>{var s=[];for(let r in e)s.push(e[r].total_vulns/1);return s};window.d=pt;window.fn=ft;
