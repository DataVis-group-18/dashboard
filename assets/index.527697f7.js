import{s as B,z as N,c as M,l as y,a as c,b as D,d as g,t as j,e as w,m as E,j as C,f as H,i as R,g as k,h as L,k as G,n as x}from"./vendor.659b84d5.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}};J();class p{constructor(t,s,a,i){this.left=i,this.right=s,this.top=t,this.bottom=a}static all(t){return new p(t,t,t,t)}}class ${constructor(t,s){this.#t=0,this.#e=0,this.elem=t,this.margin=s,this.refresh()}#t;#e;refresh(){const t=this.elem.getBoundingClientRect();this.#t=t.width,this.#e=t.height}get width(){return this.#t-this.margin.left-this.margin.right}get height(){return this.#e-this.margin.top-this.margin.bottom}}class T{constructor(t,s,a,i,r,n,o,l){this.ip_str=t,this.isp=s,this.org=a,this.os=i,this.port=r,this.timestamp=n,this.location=o,this.vulns=l}}class X{constructor(t,s,a,i,r){this.cve=t,this.count=s,this.verified=a,this.cvss=i,this.summary=r}}class K{constructor(t,s,a){this.val=t,this.name=s,this.vulns=a}total(t){return B(this.vulns.slice(t-1))}dimensions(t){const s=new Array(t-1).concat(this.vulns.slice(t-1));return N([0].concat(Array.from(M(s))),s)}}class Q{constructor(t,s,a,i,r,n,o){this.township=s,this.province=a,this.longitude=i,this.latitude=r,this.city=t,this.population=n,this.total_devices=o}}class F{constructor(t,s){this.container=t,this.margin=s,this.dimensions=new $(t,s)}get width(){return this.dimensions.width}get height(){return this.dimensions.height}}let f=null,O=null,b={};class U extends F{constructor(t,s,a){super(document.querySelector("svg#left-plot"),new p(0,20,50,140));O=t.locations,this.data=t,this.choice=a,this.onSelect=s,this.scaleElem=document.querySelector("#scale"),this.objects=[],this.groups=[],this.minCVSS=1,this.x=y(),window.addEventListener("resize",()=>{this.dimensions.refresh(),this.updateChoice(this.choice,!1)}),this.svg=c(this.container).on("click",function(){f=null,c(this).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),s(null)}).append("g").attr("transform","translate(160, 0)"),this.svg.append("rect").attr("x","0").attr("y","0").attr("width",this.dimensions.width.toString()).attr("height",this.dimensions.height.toString()).attr("opacity","0"),this.xAxis=this.svg.append("g"),this.yAxis=this.svg.append("g"),this.bars=this.svg.append("g").attr("transform","translate(1, 0)"),this.updateChoice(a);let i=!1,r=0,n=!1;this.scaleElem.addEventListener("mousedown",o=>{const l=o;i=!1,n=!0,r=l.pageX}),this.scaleElem.addEventListener("mousemove",o=>{n&&(i||Math.abs(o.pageX-r)>10)&&(i=!0,this.update(!1))}),this.scaleElem.addEventListener("mouseup",()=>{i||this.update(!0),n=!1}),document.querySelector("#min-cvss")?.addEventListener("change",o=>{this.updateChoice(this.choice)})}updateChoice(t,s=!0){this.choice=t,this.objects=Object.values(Z(this.data.shodan,this.data.vulnerabilities,this.choice)),this.minCVSS=parseInt(document.querySelector("#min-cvss").value),this.objects.sort((n,o)=>o.total(this.minCVSS)-n.total(this.minCVSS)),this.objects=this.objects.slice(0,20),console.log(this.objects[0]),this.groups=this.objects.map(n=>n.name),this.x=this.x.domain([0,this.objects[0].total(this.minCVSS)]).range([0,this.width]),this.scaleElem.max=this.objects[0].total(this.minCVSS).toString(),this.scaleElem.min=this.objects[this.objects.length-1].total(this.minCVSS).toString(),this.scaleElem.value=this.scaleElem.max,this.xAxis.attr("transform",`translate(0, ${this.height})`);const a=D().domain(this.groups).range([10,this.height]).padding(.1);this.yAxis.call(g(a).tickSizeOuter(0).tickFormat(n=>this.choice=="os"?Y(n,25):W(n,25))).selectAll("text").style("text-anchor","end");const i=n=>j((n+1)/10),r=this.onSelect;this.bars.selectAll("g").data(this.objects).join("g").attr("id",n=>n.val).attr("transform",n=>`translate(0, ${a(n.name)})`).selectAll("rect").data(n=>n.dimensions(this.minCVSS)).join("rect").attr("class",(n,o)=>o.toString()+" bar").attr("height",a.bandwidth()).attr("fill",(n,o)=>i(o)).attr("opacity","1").on("click",function(n){n.stopPropagation();const o=this.parentElement;f==o?(c(o.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),f=null,r(null)):(f=o,c(o.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","0.4"),c(o).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),r(c(f).attr("id")))}),this.update(s)}update(t=!1){this.dimensions.refresh(),this.x=this.x.domain([0,parseInt(this.scaleElem.value)]),this.xAxis.call(w(this.x)).selectAll("text").attr("transform","translate(-10,0)rotate(-45)").style("text-anchor","end"),this.bars.selectAll("g").data(this.objects).selectAll("rect").data(s=>s.dimensions(this.minCVSS)).transition().duration(t?300:0).attr("x",s=>this.x(s[0])).attr("width",s=>this.x(s[1])),this.svg.selectAll(".bar").selectAll("*").remove()}clear(){this.svg.selectAll("*").remove()}}function W(e,t){return e.length>t?e.slice(0,t-2)+"...":e}function Y(e,t){if(e.length>t){const s=e.split(" "),a=s[s.length-1];return e.slice(0,t-a.length-2)+"..."+a}else return e}function Z(e,t,s){if(s in b)return b[s];const a={};for(const i of e){if(i[s]=="")continue;const r=tt(i,s);if(r!=null){r in a||(a[r]=new K(i[s].toString(),r.toString(),[0,0,0,0,0,0,0,0,0,0]));for(const n of i.vulns)a[r].vulns[Math.floor(t[n].cvss-1)]+=1}}return b[s]=a,a}function tt(e,t){switch(t){case"location":try{return O[e.location].city}catch{return null}default:return e[t]}}class et extends F{constructor(t,s,a){super(t,new p(70,50,70,90));this.filter=null,this.filteredVulns=null,window.addEventListener("resize",()=>{this.update()}),this.shodan=s,this.vulnerabilities=a,this.cachedFilters={},this.selectedCVE=null,this.color=i=>j((i.cvss+1)/10),this.group=c(this.container).append("g").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`),this.x=y().domain([1,10]).range([0,this.width]),this.maxCount=E(a,i=>i.count),this.y=y().domain([0,this.maxCount]).range([this.height,0]),this.xAxis=this.group.append("g").attr("transform","translate(0,"+this.height+")").call(w(this.x)),this.group.append("text").attr("id","xLabel").attr("class","label").attr("text-anchor","end").attr("x",this.width).attr("y",this.height+50).text("Severity (CVSS score)"),this.yAxis=this.group.append("g").call(g(this.y)),this.group.append("text").attr("id","yLabel").attr("class","label").attr("text-anchor","end").attr("transform","rotate(-90)").attr("y",-this.margin.bottom).attr("x",0).text("Number of affected devices"),this.group.selectAll("dot").data(a).enter().append("circle").attr("r",4).attr("cvss",i=>i.cvss.toString()).on("mouseout",i=>{c(i.target).attr("opacity")!="0"&&this.tooltip.style("display","none")}).on("mouseover",(i,r)=>{if(c(i.target).attr("opacity")=="0")return;this.tooltip.style("display",null),this.tooltip.attr("transform",`translate(${this.x(r.cvss)},${+c(i.target).attr("cy")})`);const n=this.tooltip.selectAll("path").data([,]).join("path").attr("fill","white").attr("stroke","#ccc"),o=this.tooltip.selectAll("text").data([,]).join("text").call(d=>d.selectAll("tspan").data(`${r.cve}`.split(/\n/)).join("tspan").attr("x",0).attr("y",(V,z)=>`${z*1.1}em`).text(V=>V).style("font-size","0.8em")),{x:l,y:h,width:u,height:m}=o.node().getBBox();o.attr("transform",`translate(${-u/2},${h-7})`),n.attr("d",`M ${-u/2-6},-${m+21}
           H ${u/2+6}
           v ${m+12}
           H 5
           l -5,5
           l -5,-5
           H ${-u/2-5}
           z`)}).on("click",(i,r)=>{c(i.target).attr("opacity")!="0"&&(c("#cve-name").html(r.cve),c("#cve-summary").html(r.summary),c("#cve-cvss").html("CVSS: "+r.cvss.toString()).style("color",r.cvss>=7?"white":"black").style("background",this.color(r)),c("#cve-verified").html(r.verified?"verified":"unverified").style("background",r.verified?"lightblue":"lightcoral"),this.selectedCVE?.style("stroke",null),this.selectedCVE=c(i.target),this.selectedCVE.style("stroke","black"),this.update())}),this.update(),this.tooltip=this.group.append("g").style("pointer-events","none")}update(){this.dimensions.refresh(),this.x=this.x.range([1,this.width]),this.y=this.y.range([this.height,0]),this.yAxis.call(g(this.y)),this.xAxis.attr("transform","translate(0,"+this.height+")").call(w(this.x)),this.group.selectAll("circle").data(this.vulnerabilities).attr("opacity",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"0":"1").attr("pointer-events",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"none":null).attr("cy",(t,s)=>this.y(this.filteredVulns&&s in this.filteredVulns?this.filteredVulns[s]:t.count)).attr("cx",t=>this.x(t.cvss)).style("fill",this.color),this.group.select("#xLabel").attr("x",this.width).attr("y",this.height+50),this.group.select("#ylabel").attr("y",-this.margin.bottom)}setFilter(t,s){if(s){if(this.filter=s,t in this.cachedFilters&&s in this.cachedFilters[t])this.filteredVulns=this.cachedFilters[t][s];else{const a=this.shodan.filter(i=>i[t]==s).map(i=>i.vulns).flat();this.filteredVulns={};for(const i of a)i in this.filteredVulns?this.filteredVulns[i]+=1:this.filteredVulns[i]=1;t in this.cachedFilters||(this.cachedFilters[t]={}),this.cachedFilters[t][s]=this.filteredVulns}this.y=this.y.domain([0,E(Object.values(this.filteredVulns))])}else this.filter=null,this.filteredVulns=null,this.y=this.y.domain([0,this.maxCount]);this.yAxis.call(g(this.y)),this.update()}clear(){this.group.remove()}}const st={province:await C("data/nl_provinces.geojson"),township:await C("data/nl_townships.geojson")};function q(e,t,s,a){const i=document.querySelector("#resolution").value;document.querySelector("#resolution").onchange=function(){q(e,t,s,a)};const r=st[i],n=nt(t,s,e,i),o=c("svg#map").attr("viewBox","0 0 500 500");o.selectAll("*").remove(),new $(document.querySelector("svg#map"),p.all(50));const l=500,h=500,u=H().center([5.3,52.2]).scale(6e3).translate([l/2,h/2]),m=it(i,a);return o.append("g").selectAll("path").data(r.features).enter().append("path").attr("id",d=>d.properties.name).attr("fill",d=>m(n,d.properties.name)).attr("d",R().projection(u)).style("stroke","black"),n}function it(e,t){if(e==="province")var s={nil:[0,6e3,2e4,5e4],capita:[0,.005,.01,.1],fraction:[0,.03,.1,.3]},a=k().domain(s[t]).range(L[5]);else if(e==="township")var s={nil:[0,6e3,2e4,5e4],capita:[0,.005,.01,.05,.1,.5,1,5],fraction:[0,.005,.01,.05,.1,.5,1,3,10,30]},a=k().domain(s[t]).range(L[s[t].length+1]);const r={nil:n=>n.total_vulns,capita:n=>n.total_vulns/n.population,fraction:n=>n.total_vulns/n.total_devices}[t];if(e==="province")return(n,o)=>a(r(n[o]));if(e==="township")return(n,o)=>o in n?a(r(n[o])):a(0);throw"Something is very wrong if it came to this"}function nt(e,t,s,a){const i={},r=[];for(let l=0;l<e.length;l++){if(e[l].location>=s.length)continue;var n=at(e[l].location,s,a),o=rt(e[l].vulns,t);n in i||(i[n]={severity_none:0,severity_low:0,severity_medium:0,severity_high:0,severity_critial:0,total_vulns:0,population:1,total_devices:1});const h=i[n];o<.1?h.severity_none+=1:o>=.1&&o<4?h.severity_low+=1:o>=4&&o<7?h.severity_medium+=1:o>=7&&o<9?h.severity_high+=1:o>=9&&o<=10&&(h.severity_critial+=1),h.total_vulns+=1,!r.includes(e[l].location)&&(h.total_devices+=lt(e[l].location,s),h.population+=ot(e[l].location,s),r.push(e[l].location))}return i}function rt(e,t){return G(e,s=>t[s].cvss)}function at(e,t,s){return t[e][s]}function ot(e,t){return t[e].population}function lt(e,t){return t[e].total_devices}function ct(e){return e.replace(/[\- ](Service Pack)?[\- ]?[0-9]+$/g,"")}const S=await x("data/shodan.csv",e=>new T(e.ip_str,e.isp,e.org,ct(e.os),parseInt(e.port),new Date(e.timestamp),parseInt(e.location),JSON.parse(e.vulns))),_=await x("data/vulnerabilities.csv",e=>new X(e.cve,parseInt(e.count),e.verified=="true",parseFloat(e.cvss),e.summary)),I=await x("data/locations.csv",e=>new Q(e.city,e.township,e.province,parseFloat(e.longitude),parseFloat(e.latitude),parseInt(e.population),parseInt(e.total_devices))),ht={shodan:S,vulnerabilities:_,locations:I},ut="capita";let A=null;function P(e){A!=e&&(A=e,pt.setFilter(v.value,A))}const v=document.getElementById("category");v.onchange=function(){P(null),dt.updateChoice(v.value)};let dt=new U(ht,P,v.value),pt=new et(document.querySelector("svg#right-plot"),S,_);const ft=q(I,S,_,ut);var mt=(e,t)=>{var s=[];for(let a in e)s.push(e[a].total_vulns/1);return s};window.d=ft;window.fn=mt;
