import{s as P,z as q,c as z,l as x,a as c,b as B,d as g,t as j,e as b,m as C,f as N,i as M,g as D,h as H,j as R,k as w,n as T}from"./vendor.b18d1fcf.js";const X=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}};X();class p{constructor(t,s,a,i){this.left=i,this.right=s,this.top=t,this.bottom=a}static all(t){return new p(t,t,t,t)}}class E{constructor(t,s){this.#t=0,this.#e=0,this.elem=t,this.margin=s,this.refresh()}#t;#e;refresh(){const t=this.elem.getBoundingClientRect();this.#t=t.width,this.#e=t.height}get width(){return this.#t-this.margin.left-this.margin.right}get height(){return this.#e-this.margin.top-this.margin.bottom}}class G{constructor(t,s,a,i,n,r,l,o){this.ip_str=t,this.isp=s,this.org=a,this.os=i,this.port=n,this.timestamp=r,this.location=l,this.vulns=o}}class J{constructor(t,s,a,i,n){this.cve=t,this.count=s,this.verified=a,this.cvss=i,this.summary=n}}class K{constructor(t,s,a){this.val=t,this.name=s,this.vulns=a}total(t){return P(this.vulns.slice(t-1))}dimensions(t){const s=new Array(t-1).concat(this.vulns.slice(t-1));return q([0].concat(Array.from(z(s))),s)}}class Q{constructor(t,s,a,i,n,r,l){this.township=s,this.province=a,this.longitude=i,this.latitude=n,this.city=t,this.population=r,this.total_devices=l}}class k{constructor(t,s){this.container=t,this.margin=s,this.dimensions=new E(t,s)}get width(){return this.dimensions.width}get height(){return this.dimensions.height}}let f=null,$=null,S={};class U extends k{constructor(t,s,a){super(document.querySelector("svg#left-plot"),new p(0,20,50,140));$=t.locations,this.data=t,this.choice=a,this.onSelect=s,this.scaleElem=document.querySelector("#scale"),this.objects=[],this.groups=[],this.minCVSS=1,this.x=x(),this.svg=c(this.container).on("click",function(){f=null,c(this).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),s(null)}).append("g").attr("transform","translate(160, 0)"),this.svg.append("rect").attr("x","0").attr("y","0").attr("width",this.dimensions.width.toString()).attr("height",this.dimensions.height.toString()).attr("opacity","0"),this.xAxis=this.svg.append("g").attr("transform",`translate(0, ${this.height})`),this.yAxis=this.svg.append("g"),this.bars=this.svg.append("g").attr("transform","translate(1, 0)"),this.updateChoice(a);let i=!1,n=0,r=!1;this.scaleElem.addEventListener("mousedown",l=>{const o=l;i=!1,r=!0,n=o.pageX}),this.scaleElem.addEventListener("mousemove",l=>{r&&(i||Math.abs(l.pageX-n)>10)&&(i=!0,this.update(!1))}),this.scaleElem.addEventListener("mouseup",()=>{i||this.update(!0),r=!1}),document.querySelector("#min-cvss")?.addEventListener("change",l=>{this.updateChoice(this.choice)})}updateChoice(t){this.choice=t,this.objects=Object.values(Z(this.data.shodan,this.data.vulnerabilities,this.choice)),this.minCVSS=parseInt(document.querySelector("#min-cvss").value),this.objects.sort((n,r)=>r.total(this.minCVSS)-n.total(this.minCVSS)),this.objects=this.objects.slice(0,20),console.log(this.objects[0]),this.groups=this.objects.map(n=>n.name),this.x=this.x.domain([0,this.objects[0].total(this.minCVSS)]).range([0,this.width]),this.scaleElem.max=this.objects[0].total(this.minCVSS).toString(),this.scaleElem.min=this.objects[this.objects.length-1].total(this.minCVSS).toString(),this.scaleElem.value=this.scaleElem.max;const s=B().domain(this.groups).range([10,this.height]).padding(.1);this.yAxis.call(g(s).tickSizeOuter(0).tickFormat(n=>this.choice=="os"?Y(n,25):W(n,25))).selectAll("text").style("text-anchor","end");const a=n=>j((n+1)/10),i=this.onSelect;this.bars.selectAll("g").data(this.objects).join("g").attr("id",n=>n.val).attr("transform",n=>`translate(0, ${s(n.name)})`).selectAll("rect").data(n=>n.dimensions(this.minCVSS)).join("rect").attr("class",(n,r)=>r.toString()+" bar").attr("height",s.bandwidth()).attr("fill",(n,r)=>a(r)).attr("opacity","1").on("click",function(n){n.stopPropagation();const r=this.parentElement;f==r?(c(r.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),f=null,i(null)):(f=r,c(r.parentElement).selectAll("rect.bar").transition().duration(300).attr("opacity","0.4"),c(r).selectAll("rect.bar").transition().duration(300).attr("opacity","1"),i(c(f).attr("id")))}),this.update(!0)}update(t=!1){this.x=this.x.domain([0,parseInt(this.scaleElem.value)]),this.xAxis.call(b(this.x)).selectAll("text").attr("transform","translate(-10,0)rotate(-45)").style("text-anchor","end"),this.bars.selectAll("g").data(this.objects).selectAll("rect").data(s=>s.dimensions(this.minCVSS)).transition().duration(t?300:0).attr("x",s=>this.x(s[0])).attr("width",s=>this.x(s[1])),this.svg.selectAll(".bar").selectAll("*").remove()}clear(){this.svg.selectAll("*").remove()}}function W(e,t){return e.length>t?e.slice(0,t-2)+"...":e}function Y(e,t){if(e.length>t){const s=e.split(" "),a=s[s.length-1];return e.slice(0,t-a.length-2)+"..."+a}else return e}function Z(e,t,s){if(s in S)return S[s];const a={};for(const i of e){if(i[s]=="")continue;const n=tt(i,s);if(n!=null){n in a||(a[n]=new K(i[s].toString(),n.toString(),[0,0,0,0,0,0,0,0,0,0]));for(const r of i.vulns)a[n].vulns[Math.floor(t[r].cvss-1)]+=1}}return S[s]=a,a}function tt(e,t){switch(t){case"location":try{return $[e.location].city}catch{return null}default:return e[t]}}class et extends k{constructor(t,s,a){super(t,new p(70,50,70,90));this.filter=null,this.filteredVulns=null,this.shodan=s,this.vulnerabilities=a,this.cachedFilters={},this.selectedCVE=null,this.color=i=>j((i.cvss+1)/10),this.group=c(this.container).append("g").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`),this.x=x().domain([1,10]).range([0,this.width]),this.maxCount=C(a,i=>i.count),this.y=x().domain([0,this.maxCount]).range([this.height,0]),this.xAxis=this.group.append("g").attr("transform","translate(0,"+this.height+")").call(b(this.x)),this.group.append("text").attr("id","xLabel").attr("class","label").attr("text-anchor","end").attr("x",this.width).attr("y",this.height+50).text("Severity (CVSS score)"),this.yAxis=this.group.append("g").call(g(this.y)),this.group.append("text").attr("id","yLabel").attr("class","label").attr("text-anchor","end").attr("transform","rotate(-90)").attr("y",-this.margin.bottom).attr("x",0).text("Number of affected devices"),this.group.selectAll("dot").data(a).enter().append("circle").attr("r",4).attr("cvss",i=>i.cvss.toString()).on("mouseout",i=>{c(i.target).attr("opacity")!="0"&&this.tooltip.style("display","none")}).on("mouseover",(i,n)=>{if(c(i.target).attr("opacity")=="0")return;this.tooltip.style("display",null),this.tooltip.attr("transform",`translate(${this.x(n.cvss)},${+c(i.target).attr("cy")})`);const r=this.tooltip.selectAll("path").data([,]).join("path").attr("fill","white").attr("stroke","#ccc"),l=this.tooltip.selectAll("text").data([,]).join("text").call(y=>y.selectAll("tspan").data(`${n.cve}`.split(/\n/)).join("tspan").attr("x",0).attr("y",(d,I)=>`${I*1.1}em`).text(d=>d).style("font-size","0.8em")),{x:o,y:h,width:u,height:m}=l.node().getBBox();l.attr("transform",`translate(${-u/2},${h-7})`),r.attr("d",`M ${-u/2-6},-${m+21}
           H ${u/2+6}
           v ${m+12}
           H 5
           l -5,5
           l -5,-5
           H ${-u/2-5}
           z`)}).on("click",(i,n)=>{c(i.target).attr("opacity")!="0"&&(c("#cve-name").html(n.cve),c("#cve-summary").html(n.summary),c("#cve-cvss").html("CVSS: "+n.cvss.toString()).style("color",n.cvss>=7?"white":"black").style("background",this.color(n)),c("#cve-verified").html(n.verified?"verified":"unverified").style("background",n.verified?"lightblue":"lightcoral"),this.selectedCVE?.style("stroke",null),this.selectedCVE=c(i.target),this.selectedCVE.style("stroke","black"),this.update())}),this.update(),this.tooltip=this.group.append("g").style("pointer-events","none"),window.addEventListener("resize",()=>{this.update()})}update(){this.dimensions.refresh(),this.x=this.x.range([1,this.width]),this.y=this.y.range([this.height,0]),this.yAxis.call(g(this.y)),this.xAxis.attr("transform","translate(0,"+this.height+")").call(b(this.x)),this.group.selectAll("circle").data(this.vulnerabilities).attr("opacity",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"0":"1").attr("pointer-events",(t,s)=>this.filteredVulns&&!(s in this.filteredVulns)?"none":null).attr("cy",(t,s)=>this.y(this.filteredVulns&&s in this.filteredVulns?this.filteredVulns[s]:t.count)).attr("cx",t=>this.x(t.cvss)).style("fill",this.color),this.group.select("#xLabel").attr("x",this.width).attr("y",this.height+50),this.group.select("#ylabel").attr("y",-this.margin.bottom)}setFilter(t,s){if(s){if(this.filter=s,t in this.cachedFilters&&s in this.cachedFilters[t])this.filteredVulns=this.cachedFilters[t][s];else{const a=this.shodan.filter(i=>i[t]==s).map(i=>i.vulns).flat();this.filteredVulns={};for(const i of a)i in this.filteredVulns?this.filteredVulns[i]+=1:this.filteredVulns[i]=1;t in this.cachedFilters||(this.cachedFilters[t]={}),this.cachedFilters[t][s]=this.filteredVulns}this.y=this.y.domain([0,C(Object.values(this.filteredVulns))])}else this.filter=null,this.filteredVulns=null,this.y=this.y.domain([0,this.maxCount]);this.yAxis.call(g(this.y)),this.update()}clear(){this.group.remove()}}function st(e,t,s,a,i,n){const r=nt(t,s,e,i),l=c("svg#map"),o=new E(document.querySelector("svg#map"),p.all(50)),h=o.width,u=o.height,m=N().center([4.7913,52.5326]).scale(4e3).translate([h/2,u/2]),y=it(i,n);l.append("g").selectAll("path").data(a.features).enter().append("path").attr("id",d=>d.properties.name).attr("fill",d=>y(r,d.properties.name)).attr("d",M().projection(m)).style("stroke","black")}function it(e,t){const s={nil:[0,6e3,2e4,5e4],capita:[0,.005,.01,.1],fraction:[0,.03,.1,.2]},a=D().domain(s[t]).range(H[5]),n={nil:r=>r.total_vulns,capita:r=>r.total_vulns/r.population,fraction:r=>r.total_vulns/r.total_devices}[t];if(e==="province")return(r,l)=>a(n(r[l]));if(e==="township")return(r,l)=>l in r?a(n(r[l])):a(0);throw"Something is very wrong if it came to this"}function nt(e,t,s,a){const i={},n=[];for(let o=0;o<e.length;o++){if(e[o].location>=s.length)continue;var r=at(e[o].location,s,a),l=rt(e[o].vulns,t);r in i||(i[r]={severity_none:0,severity_low:0,severity_medium:0,severity_high:0,severity_critial:0,total_vulns:0,population:1,total_devices:1});const h=i[r];l<.1?h.severity_none+=1:l>=.1&&l<4?h.severity_low+=1:l>=4&&l<7?h.severity_medium+=1:l>=7&&l<9?h.severity_high+=1:l>=9&&l<=10&&(h.severity_critial+=1),h.total_vulns+=1,!n.includes(e[o].location)&&(h.total_devices+=ot(e[o].location,s),h.population+=lt(e[o].location,s),n.push(e[o].location))}return i}function rt(e,t){return R(e,s=>t[s].cvss)}function at(e,t,s){return t[e][s]}function lt(e,t){return t[e].population}function ot(e,t){return t[e].total_devices}function ct(e){return e.replace(/[\- ](Service Pack)?[\- ]?[0-9]+$/g,"")}const _=await w("data/shodan.csv",e=>new G(e.ip_str,e.isp,e.org,ct(e.os),parseInt(e.port),new Date(e.timestamp),parseInt(e.location),JSON.parse(e.vulns))),V=await w("data/vulnerabilities.csv",e=>new J(e.cve,parseInt(e.count),e.verified=="true",parseFloat(e.cvss),e.summary)),L=await w("data/locations.csv",e=>new Q(e.city,e.township,e.province,parseFloat(e.longitude),parseFloat(e.latitude),parseInt(e.population),parseInt(e.total_devices))),ht={shodan:_,vulnerabilities:V,locations:L},F="township",ut="capita",dt=await T("data/nl_"+F+"s.geojson");let A=null;function O(e){A!=e&&(A=e,ft.setFilter(v.value,A))}const v=document.getElementById("category");v.onchange=function(){O(null),pt.updateChoice(v.value)};let pt=new U(ht,O,v.value),ft=new et(document.querySelector("svg#right-plot"),_,V);st(L,_,V,dt,F,ut);
